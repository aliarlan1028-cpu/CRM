const translations = {
  zh: {
    ad: {
      title: "买美容美发产品，认准岳普湖美容美发批发店"
    },
    nav: {
      dashboard: "仪表盘",
      transaction: "交易记录",
      customers: "客户",
      products: "商品"
    },
    dashboard: {
      title: "业务仪表盘",
      totalRevenue: "累计交易额",
      monthlyRevenue: "本月交易额",
      todayRevenue: "今日交易额",
      totalCustomers: "总客户数",
      totalProducts: "总商品数",
      lowStockAlert: "即将售罄商品",
      salesTrend: "销售额历史趋势",
      shortTerm: "月度榜单",
      longTerm: "总榜单",
      topCustomersMonth: "本月购买力前十客户",
      topProductsMonth: "本月畅销前十商品",
      topCustomersAll: "累计交易额前十客户",
      paymentStructure: "收入结构",
      fullPayment: "全额收款",
      debt: "欠款金额"
    },
    transaction: {
      title: "添加交易记录",
      customer: "客户名字",
      selectCustomer: "请选择客户",
      products: "商品名称（可多选）",
      addProduct: "添加新商品",
      quantity: "商品数量",
      amount: "购买金额",
      paymentMethod: "支付方式",
      fullPayment: "全额支付",
      partialPayment: "部分支付",
      debt: "欠款",
      paidAmount: "支付金额",
      debtAmount: "欠款金额",
      date: "交易日期",
      submit: "提交",
      recent: "最近交易",
      filterDate: "筛选日期",
      filter: "筛选",
      reset: "重置"
    },
    customers: {
      title: "客户列表",
      search: "搜索客户...",
      addNew: "添加客户",
      customerName: "客户名称"
    },
    products: {
      title: "商品列表",
      search: "搜索商品...",
      addNew: "添加新商品",
      productName: "商品名称",
      totalQuantity: "商品总数量"
    },
    customerDetail: {
      monthlyRevenue: "本月交易额",
      totalRevenue: "累计交易金额",
      currentPoints: "当前累计积分",
      totalDebt: "累计欠款金额",
      paidAmount: "已还款",
      pendingDebt: "待还款",
      topProducts: "购买的前10商品",
      pointsHistory: "积分兑换记录",
      paymentHistory: "还款记录",
      redeem: "兑换积分",
      recordPayment: "已收款",
      redeemPoints: "兑换积分",
      availablePoints: "可用积分",
      redeemAmount: "兑换积分数",
      paymentAmount: "收款金额"
    },
    productDetail: {
      monthlySales: "本月销量",
      topCustomers: "购买该商品的前10用户",
      restock: "补货",
      restockQuantity: "补货数量",
      totalQuantity: "总数量",
      remainingQuantity: "剩余数量"
    },
    common: {
      back: "返回",
      save: "保存",
      cancel: "取消",
      confirm: "确认",
      edit: "编辑",
      delete: "删除"
    }
  },
  ug: {
    ad: {
      title: "گۈزەللىك مەھسۇلاتلىرى ئالماقچى بولسىڭىز، يۇپۇرغا يېڭى دەۋىر دۇكۇنىنى تاللاڭ"
    },
    nav: {
      dashboard: "داشبورد",
      transaction: "سودا خاتىرىسى",
      customers: "خېرىدارلار",
      products: "مەھسۇلاتلار"
    },
    dashboard: {
      title: "كارخانا داشبوردى",
      totalRevenue: "جەمئىي سودا مىقدارى",
      monthlyRevenue: "بۇ ئايدىكى سودا مىقدارى",
      todayRevenue: "بۈگۈنكى سودا مىقدارى",
      totalCustomers: "جەمئىي خېرىدار سانى",
      totalProducts: "جەمئىي مەھسۇلات سانى",
      lowStockAlert: "تېزلا تۈگىدىغان مەھسۇلاتلار",
      salesTrend: "سېتىلىش مىقدارى تارىخىي ئېگىشىشى",
      shortTerm: "ئايلىق تىزىملىك",
      longTerm: "ئومۇمىي تىزىملىك",
      topCustomersMonth: "بۇ ئايدا سېتىۋېلىش كۈچى ئەڭ يۇقىرى بولغان 10 خېرىدار",
      topProductsMonth: "بۇ ئايدا ئەڭ كۆپ سېتىلغان 10 مەھسۇلات",
      topCustomersAll: "جەمئىي سودا مىقدارى ئەڭ يۇقىرى بولغان 10 خېرىدار",
      paymentStructure: "كىرىم قۇرۇلمىسى",
      fullPayment: "تولۇق تاپشۇرۇش",
      debt: "قەرز مىقدارى"
    },
    transaction: {
      title: "سودا خاتىرىسى قوشۇش",
      customer: "خېرىدار ئىسمى",
      selectCustomer: "خېرىدار تاللاڭ",
      products: "مەھسۇلات ئىسمى (كۆپ تاللاش مۇمكىن)",
      addProduct: "يېڭى مەھسۇلات قوشۇش",
      quantity: "مەھسۇلات سانى",
      amount: "سېتىۋېلىش مىقدارى",
      paymentMethod: "تاپشۇرۇش ئۇسۇلى",
      fullPayment: "تولۇق تاپشۇرۇش",
      partialPayment: "قىسىم تاپشۇرۇش",
      debt: "قەرز",
      paidAmount: "تاپشۇرۇلغان مىقدار",
      debtAmount: "قەرز مىقدارى",
      date: "سودا چېسى",
      submit: "تاپشۇرۇش",
      recent: "يېقىنقى سودا خاتىرىلىرى",
      filterDate: "چېسا سۈزگۈچ",
      filter: "سۈزگۈچ",
      reset: "قايتا تەڭشەش"
    },
    customers: {
      title: "خېرىدارلار تىزىمى",
      search: "خېرىدار ئىزدەش...",
      addNew: "خېرىدار قوشۇش",
      customerName: "خېرىدار ئىسمى"
    },
    products: {
      title: "مەھسۇلاتلار تىزىمى",
      search: "مەھسۇلات ئىزدەش...",
      addNew: "يېڭى مەھسۇلات قوشۇش",
      productName: "مەھسۇلات ئىسمى",
      totalQuantity: "مەھسۇلات جەمئىي سانى"
    },
    customerDetail: {
      monthlyRevenue: "بۇ ئايدىكى سودا مىقدارى",
      totalRevenue: "جەمئىي سودا مىقدارى",
      currentPoints: "نۆۋەتتىكى جەمئىي ئۇچۇر",
      totalDebt: "جەمئىي قەرز مىقدارى",
      paidAmount: "تاپشۇرۇلغان",
      pendingDebt: "كۈتۈۋاتقان قەرز",
      topProducts: "سېتىۋالغان ئالدىنقى 10 مەھسۇلات",
      pointsHistory: "ئۇچۇر ئالماشتۇرۇش خاتىرىسى",
      paymentHistory: "تاپشۇرۇش خاتىرىسى",
      redeem: "ئۇچۇر ئالماشتۇرۇش",
      recordPayment: "تاپشۇرۇش قوبۇل قىلىش",
      redeemPoints: "ئۇچۇر ئالماشتۇرۇش",
      availablePoints: "ئىشلىتىشكە بولىدىغان ئۇچۇر",
      redeemAmount: "ئالماشتۇرىدىغان ئۇچۇر سانى",
      paymentAmount: "تاپشۇرۇلغان مىقدار"
    },
    productDetail: {
      monthlySales: "بۇ ئايدىكى سېتىلىش مىقدارى",
      topCustomers: "بۇ مەھسۇلاتنى سېتىۋالغان ئالدىنقى 10 ئىشلەتكۈچى",
      restock: "مەھسۇلات تولدۇرۇش",
      restockQuantity: "تولدۇرۇش سانى",
      totalQuantity: "جەمئىي سانى",
      remainingQuantity: "قالدۇق سانى"
    },
    common: {
      back: "قايتىش",
      save: "ساقلاش",
      cancel: "ئەمەلدىن قالدۇرۇش",
      confirm: "جەزملەش",
      edit: "تەھرىرلەش",
      delete: "ئۆچۈرۈش"
    }
  }
};

let currentLang = 'zh';

function setLanguage(lang) {
  if (currentLang === lang) return; // 如果已经是当前语言，不执行切换
  
  // 添加过渡效果
  document.body.style.transition = 'opacity 0.2s ease-in-out';
  document.body.style.opacity = '0.7';
  
  // 使用 requestAnimationFrame 确保平滑过渡
  requestAnimationFrame(() => {
    currentLang = lang;
    document.documentElement.lang = lang === 'ug' ? 'ug' : 'zh-CN';
    
    // 设置字体方向
    if (lang === 'ug') {
      document.documentElement.dir = 'rtl';
      document.body.classList.add('rtl');
    } else {
      document.documentElement.dir = 'ltr';
      document.body.classList.remove('rtl');
    }
    
    // 更新所有文本
    document.querySelectorAll('[data-i18n]').forEach(element => {
      const key = element.getAttribute('data-i18n');
      const value = getTranslation(key);
      if (value) {
        element.textContent = value;
      }
    });
    
    // 更新占位符
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
      const key = element.getAttribute('data-i18n-placeholder');
      const value = getTranslation(key);
      if (value) {
        element.placeholder = value;
      }
    });
    
    // 更新 select 选项
    const customerSelect = document.getElementById('customer-select');
    if (customerSelect && customerSelect.firstElementChild) {
      const firstOption = customerSelect.firstElementChild;
      if (firstOption.value === '') {
        firstOption.textContent = getTranslation('transaction.selectCustomer');
      }
    }
    
    // 保存语言设置
    localStorage.setItem('language', lang);
    
    // 恢复透明度
    requestAnimationFrame(() => {
      document.body.style.opacity = '1';
      setTimeout(() => {
        document.body.style.transition = '';
      }, 200);
    });
    
    // 触发语言变更事件
    window.dispatchEvent(new CustomEvent('languageChanged', { detail: lang }));
  });
}

function getTranslation(key) {
  const keys = key.split('.');
  let value = translations[currentLang];
  for (const k of keys) {
    value = value?.[k];
  }
  return value || key;
}

function t(key) {
  return getTranslation(key);
}

// 初始化语言
function initLanguage() {
  const savedLang = localStorage.getItem('language') || 'zh';
  setLanguage(savedLang);
  
  // 使用事件委托处理语言切换按钮（确保PWA模式下也能工作）
  document.addEventListener('click', (e) => {
    if (e.target.id === 'lang-zh' || e.target.closest('#lang-zh')) {
      e.preventDefault();
      e.stopPropagation();
      setLanguage('zh');
    } else if (e.target.id === 'lang-ug' || e.target.closest('#lang-ug')) {
      e.preventDefault();
      e.stopPropagation();
      setLanguage('ug');
    }
  });
  
  // 更新按钮状态
  updateLanguageButtons();
}

// 支持多种初始化方式，确保PWA模式下也能工作
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initLanguage);
} else {
  // DOM已经加载完成，直接初始化
  initLanguage();
}

function updateLanguageButtons() {
  document.getElementById('lang-zh').classList.toggle('active', currentLang === 'zh');
  document.getElementById('lang-ug').classList.toggle('active', currentLang === 'ug');
}

// 监听语言变更事件
window.addEventListener('languageChanged', () => {
  updateLanguageButtons();
});

